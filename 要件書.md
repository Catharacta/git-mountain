# GitHub Contributions — 山脈風 3D ビジュアル 要件仕様（修正版）

最終更新: 2025-12-20  
作成者: 自動生成（レビュー済）  
対象: 北半球基準、貢献数（高さ）に応じた色付けを行う GitHub プロフィール用画像生成サービス

## 1. 概要
ユーザーの GitHub コントリビューション（日次）を「山脈風の 3D グラフ」として可視化し、各メッシュ頂点の高さ（貢献数）に応じて季節別のカラーパレットで色を割り当てる。季節判定は北半球基準で固定する。生成画像は毎日 GitHub Actions により自動生成され、プロフィール README で参照できる URL へ配置されることを目的とする。

---

## 2. 範囲（Scope）
- 対象ユーザー: GitHub アカウント保持者（北半球を前提）
- 出力形式: 静止画像（優先: WebP、代替: PNG）
- 自動化: GitHub Actions（daily cron + manual dispatch）
- 色付け基準: 各セル（= 日）の高さ（貢献数）を正規化し、季節パレット上で補間して決定する

---

## 3. 機能要件（Functional Requirements）

### 3.1 入力・設定
- 必須入力
  - user: GitHub ユーザー名（デフォルト: ワークフローを実行するリポジトリのオーナー）
  - period: 出力対象期間（例: past_year / last_n_days / custom with from/to）
  - output.path: 生成ファイル格納パス（例: assets/contrib-mountain.webp）
- オプション（デフォルト推奨値を持つ）
  - render.width, render.height（例: 1200×700）
  - render.format: webp | png（デフォルト: webp）
  - color.transitionDays: 季節境界での補間日数（デフォルト: 14）
  - scale.mode: linear | log（デフォルト: linear）
  - render.maxHeightUnits: メッシュ最大高さ（default: 40）
  - output.commitIfChanged: true|false（デフォルト: true）

設定は YAML ファイル（例: `.github/mountain-config.yml`）または Action inputs から指定可能。

### 3.2 データ取得
- 使用 API: GitHub GraphQL API v4 の contributionsCollection（contributionCalendar → weeks → contributionDays）
- 取得する最小データ: 日付 (`date`)、日次貢献数 (`contributionCount`)
- 方針: スクレイピングは行わない。GraphQL を一次ソースとする。

### 3.3 季節判定（北半球固定）
- 判定方式: 気象学的（meteorological）を採用
  - 春: 3–5 月、夏: 6–8 月、秋: 9–11 月、冬: 12–2 月
- 生成タイミングに応じてその日の季節を判定し、該当季節のパレットを使用
- transitionDays が指定されている場合、季節境界の前後 transitionDays 期間は周辺季節との線形補間を行う

### 3.4 色付け（高さベース）
- 各日ごとの `contributionCount` を正規化して 0..1 の値に変換する
  - 正規化方法: period 内の `maxCount` を基準に (count / maxCount)（scale.mode に基づく代替ロジック可）
  - maxCount = 0（全活動なし）の場合は全頂点を高さ 0 と扱い、プレースホルダ色を適用
- パレット適用法:
  - 季節ごとに配列 palette = [c0, c1, ..., cN] を定義
  - 正規化値 x を palette 上で線形補間して最終色を決定
  - シェーダーまたは頂点カラーで適用する（実装依存）
- optional: ridgeColor（高さ閾値を超えた頂稜に別色を重ねる）

### 3.5 3D モデル生成・レンダリング
- 格子配置: 横軸=週、縦軸=曜日、各セルがメッシュの頂点または棒（立方体）に対応
- レンダリング推奨: Three.js を用い headless Chrome（Puppeteer）でレンダリング → スクリーンショット（理由: 見た目の再現性、ライティング表現）
- 必須レンダリング要素:
  - カメラ（斜め俯瞰、設定可能）
  - ライティング（環境光 + 1〜2 点ライト）
  - シャドウと法線計算による立体感
- 出力画像は指定サイズで生成し、sharp 等で WebP に変換・最適化する

### 3.6 自動化（GitHub Actions）
- ワークフロー:
  - トリガー: `schedule: cron`（デフォルト: daily）および `workflow_dispatch`
  - 権限: `permissions.contents: write` を付与（画像をコミットする場合）
  - ステップ例:
    1. actions/checkout
    2. setup-node
    3. npm ci
    4. node scripts/fetch-contribs.js → JSON 出力
    5. node scripts/generate-mountain.js → 画像生成
    6. sharp による最適化
    7. 差分確認（git diff）→ 変更あれば commit & push
- ログ出力（必須）: `season`, `paletteUsed`, `maxCount`, `outputPath`, `outputFileSize` を Actions のログに出力すること

### 3.7 配布・README への埋め込み
- 生成画像はリポジトリ内（例: `assets/`）または `gh-pages` ブランチへ配置して README から参照する
- README 内の `<img src="...">` を自動で更新する機能はオプション（実装時は差分コミットルールを厳格に）
- 画像 URL は raw.githubusercontent.com または gh-pages のいずれかを想定

### 3.8 フォールバック・エラーハンドリング
- データ取得／レンダリング失敗時は既存の画像を保持し、新しい破損画像で上書きしない
- 生成に失敗したことを分かりやすく示すログ・通知（Action failed）を出す
- プレースホルダ画像（活動なし／エラー時用）を準備して README 表示が壊れないようにする

---

## 4. 非機能要件（Non-functional Requirements）
- 実行時間: 単一 Action 実行は目標 10 分未満（レンダリング複雑度に依存）
- 生成画像サイズ: WebP で 500KiB 以下を目安（設定で品質調整可能）
- 可用性: GitHub Actions に依存（SLA に依存）
- セキュリティ:
  - トークンは GitHub Secrets に保管（GITHUB_TOKEN または最小権限の PAT）
  - 生成画像に個人情報を含めない
- 保守性: コンポーネントは「データ取得」「正規化」「レンダリング」「最適化」「git 操作」に分離する

---

## 5. 技術要件（Technical Requirements / Implementation）

### 5.1 実行環境
- GitHub Actions（.github/workflows/generate.yml）
- Node.js 16+（推奨）、npm または yarn
- 主要パッケージ（例）
  - three, puppeteer, sharp, @octokit/graphql

### 5.2 GraphQL クエリ（サンプル）
```graphql
query($login: String!, $from: DateTime!, $to: DateTime!) {
  user(login: $login) {
    contributionsCollection(from: $from, to: $to) {
      contributionCalendar {
        weeks {
          contributionDays {
            date
            contributionCount
          }
        }
      }
    }
  }
}
```

### 5.3 色補間（シェーダー／ロジック）
- パレット interpolation:
  - インデックス s = x * (paletteSize - 1)
  - color = mix(palette[floor(s)], palette[ceil(s)], fract(s))
- シェーダー実装（GLSL）を推奨。頂点カラーでも可。

### 5.4 スケーリング（正規化の選択）
- linear:
  - normalized = count / maxCount
- log:
  - normalized = log(1 + alpha * count) / log(1 + alpha * maxCount) — alpha は感度パラメータ

### 5.5 画像最適化
- sharp を用いて WebP 変換（例: quality: 75、strip metadata）
- 出力前に resize・圧縮を実施

### 5.6 Git 操作
- 差分が無ければコミットしない（git diff --quiet）
- コミットメッセージ例: "chore: update contrib mountain image (generated at 2025-12-20T00:00Z)"
- GITHUB_TOKEN（または secrets.GH_TOKEN）を使用

---

## 6. 設定ファイルスキーマ（推奨 .github/mountain-config.yml）
```yaml
user: "your-username"            # required
period:
  mode: "past_year"              # past_year | last_n_days | custom
  last_n_days: 365               # if mode=last_n_days
  custom:
    from: "2024-12-01"           # if mode=custom
    to:   "2025-11-30"
season:
  hemisphere: "north"            # fixed (must be "north")
  mode: "meteorological"         # fixed for current scope
  transitionDays: 14
color:
  spring: ["#A8E6CF", "#56C596", "#2D8F6F"]
  summer: ["#FFD86B", "#FFB347", "#FF6F3C"]
  autumn: ["#FFB88C", "#D97904", "#7A3B1E"]
  winter: ["#E6F0FF", "#A7C2FF", "#6078D8"]
  ridgeColor: "#FFFFFF"
render:
  width: 1200
  height: 700
  format: "webp"
  scale: "linear"
  maxHeightUnits: 40
output:
  path: "assets/contrib-mountain.webp"
  commitIfChanged: true
action:
  cron: "0 0 * * *"
```

---

## 7. 受け入れ基準（Acceptance Criteria / テスト）
- 毎日（または manual 実行で）Action が起動し、成功ログを出力すること
- 生成ログに少なくとも以下が含まれること:
  - season: <spring|summer|autumn|winter>
  - paletteUsed: <season>
  - maxCount: <n>
  - outputPath: <path>
  - outputFileSize: <bytes>
- 生成画像の色が高さに応じて palette 内で補間されていること（視覚確認）
- 出力画像が指定パスに作成され、WebP であればファイルサイズが設定閾値内であること
- 差分がない場合、コミットは行われないこと
- 例外（GraphQL 失敗等）発生時は旧画像を保持し、README 表示が壊れないこと

---

## 8. 異常系・境界条件
- 期間内 maxCount = 0:
  - 全て高さ 0。プレースホルダ色を出力（パレットの最小色を採用する等）
- API rate-limit:
  - 単一ユーザーの取得では通常問題にならないが、失敗時はリトライを行い、一定回数で処理を中断してログ出力
- Headless 環境の失敗:
  - Puppeteer のバージョン固定・依存ライブラリの明示で再現性を高める

---

## 9. 実装ロードマップ（短期優先）
1. GraphQL データ取得モジュールの実装と単体テスト
2. 正規化・スケーリングロジック実装（linear / log）
3. Three.js + Puppeteer を用いた最小レンダラー作成（高さ→頂点カラー）
4. カラーパレット適用（季節判定を北半球固定で実装）
5. Actions ワークフローの追加（cron + workflow_dispatch）
6. 受け入れテストとドキュメント整備

---

## 10. 追記（レビューで修正した主な点）
- 「季節は北半球のみ」に明確化（南半球対応は将来的拡張）
- 差分コミットの動作・ログ出力を明確化
- 生成画像の最小要件（形式、サイズ目安）を追加
- 異常時のフォールバック動作を明文化

---

## 11. 付録（短いコード例）

### 季節判定（北半球・気象学的）
```js
function seasonForDateUTC(date) {
  const m = date.getUTCMonth() + 1; // 1..12
  if (m >= 3 && m <= 5) return "spring";
  if (m >= 6 && m <= 8) return "summer";
  if (m >= 9 && m <= 11) return "autumn";
  return "winter";
}
```

### 色補間（擬似）
```js
// palette: array of hex strings
// x: normalized height 0..1
function interpColor(palette, x) {
  const n = palette.length;
  const s = x * (n - 1);
  const i = Math.floor(s);
  const t = s - i;
  const c1 = hexToRgb(palette[i]);
  const c2 = hexToRgb(palette[Math.min(i + 1, n - 1)]);
  return rgbToHex(lerp(c1, c2, t));
}
```
